---
title: ""
author: ""
date: ""
output:
  pdf_document:
    toc: false
    latex_engine: xelatex
header-includes:
  \usepackage{fontspec}
  \usepackage[utf8]{inputenc}
  \setmainfont{Arial}
  \usepackage{pdfpages}
  \usepackage{graphicx}
  \usepackage{siunitx}
---

```{r setup, include=FALSE, message=FALSE, echo=FALSE}
library(knitr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(patchwork)
library(pROC)
library(gtsummary)
library(ggpubr)
library(gt)
library(ggnewscale)
library(ggrepel)
library(ComplexHeatmap)
library(ggtext)
knitr::opts_chunk$set(message = F,
                      warning = F,
                      echo = F,
                      eval = F)
# # 
# # Colour palette
cols <- MetBrewer::met.brewer("Hokusai1", n = 9)
cols2 <- MetBrewer::met.brewer("Hiroshige", n = 9)
cols3 <- colorRampPalette(cols2)(16)

# 
# # Themes
theme_gtsummary_journal(journal = "nejm")
theme_gtsummary_compact()

# # Functions
source("0-source/correct_ic.R")
source("0-source/smallAUCplot.R")
source("0-source/manhattan.R")
source("0-source/qqplot.R")
source("0-source/plot_3_rocs.R")
source("0-source/plot_2_rocs.R")
```


\vspace*{4cm}


\large 
\textbf{Supporting information for}\newline
Smoking-related Products Elicit Distinct Epigenetic Changes in Epithelial and Immune Cells

\vspace{1em}

\normalsize

Chiara Herzog, Allison Jones, Iona Evans, Michal Zikan, David Cibula, Rebecca C. Richmond and Martin Widschwendter\newline

Martin Widschwendter\newline
email: martin.widschwender@uibk.ac.at

\vspace{1.5em}

\textbf{This PDF file includes:}

> Figures S1 to S11 \newline
> Tables S1 to S6

\tableofcontents
\newcommand\invisiblesection[1]{%
  \refstepcounter{section}%
  \addcontentsline{toc}{section}{\protect\numberline{\thesection}#1}%
  \sectionmark{#1}}
  
\newpage

\section{Main figures and data}

\invisiblesection{Figure 1. Overview of the study and identification of cell type-specific CpG groups}

```{r fig1}
# a = schematic

# load sites
load("1-analysis-pipeline/2-output/plot_matrix.Rdata")
load("1-analysis-pipeline/2-output/WID_SMK_cpgs.Rdata")

WID_SMK_cpgs <- WID_SMK_cpgs |>
  dplyr::mutate(set = gsub("_", " ", set),
                set = factor(set, levels = c("epithelial hypoM",
                                             "immune hypoM",
                                             "distal epithelial hyperM",
                                             "proximal epithelial hyperM")))

# Fig B: Examples across diverse tissues -------------------------
load("1-analysis-pipeline/0-data/data.Rdata")

tmp <- data |>
  dplyr::filter(dataset == 'discovery set' & smoking_history != "Ex-smoker") |>
  tidyr::pivot_longer(c(cg24688690, cg04066994, cg21566642, cg27157482),
                      names_to = 'cg',
                      values_to = 'beta') |> 
  dplyr::mutate(ic = ifelse(sampletype == "blood", (1 - (hepidish_Mono + hepidish_Neutro + hepidish_Eosino)), ic),
                sampletype = factor(sampletype, levels = c("buccal", "cervical", "blood")),
                
                # epi hypoM
                arrows_x_epi_hypoM = ifelse(sampletype != 'blood', -0.05, NA),
                arrows_xend_epi_hypoM = ifelse(sampletype != 'blood', -0.05, NA),
                arrows_y_epi_hypoM = case_when(cg == 'cg04066994' & sampletype == 'buccal' ~ 0.7,
                                               cg == 'cg04066994' & sampletype == 'cervical' ~ 0.65,
                                               TRUE ~ NA),
                arrows_yend_epi_hypoM = case_when(cg == 'cg04066994' & sampletype == 'buccal' ~ 0.8,
                                               cg == 'cg04066994' & sampletype == 'cervical' ~ 0.79,
                                               TRUE ~ NA),
                text_epi_hypoM_x = case_when(cg == 'cg04066994' & sampletype %in% c('buccal', 'cervical') ~ -0.2,
                                          TRUE ~ NA),
                text_epi_hypoM_y = case_when(cg == 'cg04066994' & sampletype %in% c('buccal', 'cervical') ~ 0.7,
                                          TRUE ~ NA),
                text_epi_hypoM = 'epithelial ∆ β',
                
                # prox epi hyperM
                arrows_x_prox_epi_hyperM = ifelse(sampletype == 'buccal', -0.05, NA),
                arrows_xend_prox_epi_hyperM = ifelse(sampletype == 'buccal', -0.05, NA),
                arrows_y_prox_epi_hyperM = case_when(cg == 'cg24688690' & sampletype == 'buccal' ~ 0.32,
                                               TRUE ~ NA),
                arrows_yend_prox_epi_hyperM = case_when(cg == 'cg24688690' & sampletype == 'buccal' ~ 0.39,
                                                  TRUE ~ NA),
                text_prox_epi_hyperM_x = case_when(cg == 'cg24688690' & sampletype == 'buccal' ~ -0.2,
                                          TRUE ~ NA),
                text_prox_epi_hyperM_y = case_when(cg == 'cg24688690' & sampletype == 'buccal'~ 0.45,
                                          TRUE ~ NA),
                text_prox_epi_hyperM = 'epithelial ∆ β',
                
                # # distal epi hyperM
                # arrows_x_dist_hyperM = ifelse(sampletype == 'cervical', -0.05, NA),
                # arrows_xend_dist_hyperM = ifelse(sampletype == 'cervical', -0.05, NA),
                # arrows_y_dist_hyperM = case_when(cg == 'cg27157482' & sampletype == 'cervical' ~ 0.18,
                #                                      TRUE ~ NA),
                # arrows_yend_dist_hyperM = case_when(cg == 'cg27157482' & sampletype == 'cervical' ~ 0.24,
                #                                         TRUE ~ NA),
                
                # imm hypoM
                arrows_x_imm_hypoM = ifelse(sampletype == 'blood', -0.05, 1.05),
                arrows_xend_imm_hypoM = ifelse(sampletype == 'blood', -0.05, 1.05),
                arrows_y_imm_hypoM = case_when(cg == 'cg21566642' & sampletype == 'buccal' ~ 0.39,
                                                     cg == 'cg21566642' & sampletype == 'cervical' ~ 0.42,
                                                     cg == 'cg21566642' & sampletype == 'blood' ~ 0.4),
                arrows_yend_imm_hypoM = case_when(cg == 'cg21566642' & sampletype == 'buccal' ~ 0.48,
                                                  cg == 'cg21566642' & sampletype == 'cervical' ~ 0.59,
                                                  cg == 'cg21566642' & sampletype == 'blood' ~ 0.55),
                text_imm_hypoM_x = case_when(cg == 'cg21566642' & sampletype == 'buccal' ~ 1.2,
                                          cg == 'cg21566642' & sampletype == 'cervical' ~ 1.2,
                                          cg == 'cg21566642' & sampletype == 'blood' ~ -0.2),
                text_imm_hypoM_y = case_when(cg == 'cg21566642' & sampletype == 'buccal' ~ 0.5,
                                          cg == 'cg21566642' & sampletype == 'cervical' ~ 0.5,
                                          cg == 'cg21566642' & sampletype == 'blood' ~ 0.5),
                text_imm_hypoM = 'immune* ∆ β'
  )

b <- tmp |>
  dplyr::filter(cg != 'cg27157482') |> 
  dplyr::mutate(cg = factor(cg, levels = c('cg04066994',
                                           'cg21566642',
                                           'cg24688690'))) |> 
  ggplot()+
  geom_point(size = 0.5,
             alpha = 0.8,
             aes(x = ic,
             y = beta,
             colour = smoking_history)) +
  facet_grid(cg~sampletype,switch = "y") +
  scale_colour_manual(values = cols2[c(7, 1)], name = "") +
  theme_bw() +
  theme(legend.position = "top",
        # strip.background = element_rect(fill = cols2[5]),
        panel.border = element_rect(colour = "grey60",
                                    fill = NA),
        aspect.ratio = 0.7) +
  new_scale_color() +
  geom_smooth(method = "lm", se = F,aes(x = ic,
             y = beta,colour = smoking_history)) +
    scale_colour_manual(values = cols3[c(13, 1)], name = "") +
  labs(y = "methylation β", x = "immune* proportion") +
  geom_segment(aes(x = arrows_x_epi_hypoM, xend = arrows_xend_epi_hypoM,
                y = arrows_y_epi_hypoM, yend = arrows_yend_epi_hypoM),
            arrow = arrow(ends = "both", length = unit(0.1, "cm")),
            linewidth = 0.4, colour = cols[3]) +
  geom_segment(aes(x = arrows_x_prox_epi_hyperM, xend = arrows_xend_prox_epi_hyperM,
                   y = arrows_y_prox_epi_hyperM, yend = arrows_yend_prox_epi_hyperM),
               arrow = arrow(ends = "both", length = unit(0.1, "cm")),
               linewidth = 0.4, colour = cols[3]) +
  geom_segment(aes(x = arrows_x_imm_hypoM, xend = arrows_xend_imm_hypoM,
                   y = arrows_y_imm_hypoM, yend = arrows_yend_imm_hypoM),
               arrow = arrow(ends = "both", length = unit(0.1, "cm")),
               linewidth = 0.4, colour = cols[5]) +
  geom_text(aes(x = text_epi_hypoM_x, y = text_epi_hypoM_y, label = text_epi_hypoM,
                fontface = 'bold'),
            angle = 90, colour = cols[3], size = 3.5,
            check_overlap = T) +
  geom_text(aes(x = text_prox_epi_hyperM_x, y = text_prox_epi_hyperM_y, label = text_prox_epi_hyperM,
                fontface = 'bold'),
            angle = 90, colour = cols[3], size = 3.5,
            check_overlap = T) +
  geom_text(aes(x = text_imm_hypoM_x, y = text_imm_hypoM_y, label = text_imm_hypoM,
                fontface = "bold"),
            angle = 90, colour = cols[5], size = 3.5,
            check_overlap = T) +
  ylim(c(0.2, 1))

grDevices::cairo_pdf("2-markdown/1-figure-panels/1b.pdf", width = 8, height = 6)
print(b)
dev.off()



# C: Clustered heatmap ---------------------------
ind <- match(WID_SMK_cpgs$cg, rownames(mat))
mat2 <- mat[ind,]
colnames(mat2) <- c("epithelial (buccal)", "immune (buccal)",
                   "epithelial (cervical)", "immune (cervical)",
                   "myeloid (blood)", "lymphoid (blood)")



ha = columnAnnotation(
  exposure = c("proximal", "proximal", rep("distal", 4)),
  cell = c(rep(c("epithelial", "immune"), 2), "immune", "immune"),
  col = list(exposure = c("proximal" = cols[9],
                          "distal" = cols[7]),
             cell = c("epithelial" = cols[3],
                        "immune" = cols[6])),
  simple_anno_size = unit(0.3, "cm"),
  show_annotation_name = F
  )

sets <- factor(gsub(" ", "\n", WID_SMK_cpgs$set), levels = c("epithelial\nhypoM",
                                                             "immune\nhypoM",
                                                             "distal\nepithelial\nhyperM",
                                                             "proximal\nepithelial\nhyperM"))

p <- Heatmap(mat2,
        show_row_names = F,
        show_row_dend = F,
        name = "∆ β",
        row_split = sets,
        row_title_rot = 0,
        cluster_rows = T,
        cluster_row_slices = T,
        cluster_columns = T,
        column_km = 3,
        column_names_gp = grid::gpar(fontsize = 9),
        column_title = NULL,
        col = circlize::colorRamp2(breaks = seq(from = -0.2, to = 0.2,
                                                length.out = 9),
                                   colors = rev(cols2)),
        top_annotation = ha,
        row_title_gp = grid::gpar(fontsize = 9)
        )


#
grDevices::cairo_pdf("2-markdown/1-figure-panels/1c.pdf", width = 3.75, height = 6.5)
print(p)
dev.off()
```

\includegraphics[trim = 0 2.5cm 0 0]{1-figure-panels/Figure_1.pdf}

\newpage

\invisiblesection{Figure 2. Combined methylation scores of CpGs in the four sets and annotation.}

```{r}
# A Values in discovery set ---------------------------
load("1-analysis-pipeline/0-data/data.Rdata")

# Name sets for plotting and amend IC to 1-myeloid for blood sample
# Rename score names
data <- data |>
  dplyr::filter(dataset == "discovery set") |>
  dplyr::mutate(set = paste0(dataset, "\n", sampletype, " sample"),
                set = factor(set, levels = c("discovery set\nbuccal sample",
                                             "discovery set\nblood sample",
                                             "discovery set\ncervical sample")),
                ic = ifelse(sampletype == "blood",
                            (1 - (hepidish_Mono + hepidish_Neutro + hepidish_Eosino)),
                            ic)) |>
  tidyr::pivot_longer(cols = c("WID_SMK_epithelial_hypoM", "WID_SMK_immune_hypoM", "WID_SMK_distal_epithelial_hyperM", "WID_SMK_proximal_epithelial_hyperM"),
                      names_to = "score",
                      values_to = "value") |>
  dplyr::mutate(score = gsub("WID_SMK_", "", score),
                score = gsub("_", " ", score),
                score = factor(score, levels = c("epithelial hypoM",
                                                 "immune hypoM",
                                                 "distal epithelial hyperM",
                                                 "proximal epithelial hyperM")),
                smoking_history = factor(smoking_history, levels = c("Never smoker",
                                                                     "Ex-smoker",
                                                                     "Smoker")))
# Remove ex-smoker for clarity
# Buccal
a21 <- data |>
  dplyr::filter(smoking_history != "Ex-smoker" & sampletype == "buccal") |>
    ggplot(aes(x = ic,
               y = value)) +
    geom_point(size = 0.5,
               alpha = 0.3,
               aes(colour = smoking_history)) +
    facet_wrap(~score,ncol = 4, scales =  "free_y") +
    scale_colour_manual(values = cols2[c(7, 1)], name = "") +
    theme_bw() +
    theme(legend.position = "top",
          # strip.background = element_rect(fill = cols2[5]),
          panel.border = element_rect(colour = "grey60",
                                      fill = NA),
          axis.title.y = element_markdown(),
          aspect.ratio = 0.6) +
    xlab("immune cell proportion") +
    ylab("mean β<br><b style='color:#224B5E'>buccal sample</b>") +
  new_scale_colour() +
    geom_smooth(method = "lm", se = F,
                aes(x = ic, y = value, colour = smoking_history)) +
    scale_colour_manual(values = cols3[c(13, 1)], name = "")

grDevices::cairo_pdf("2-markdown/1-figure-panels/2a1.pdf", width = 8.5, height = 2.5)
print(a21)
dev.off()


# Blood
a22 <- data |>
  dplyr::filter(smoking_history != "Ex-smoker" & sampletype == "blood") |>
    ggplot(aes(x = ic,
               y = value)) +
    geom_point(size = 0.5,
               alpha = 0.3,
               aes(colour = smoking_history)) +
    facet_wrap(~score,ncol = 4) +
    scale_colour_manual(values = cols2[c(7, 1)], name = "") +
    theme_bw() +
    theme(legend.position = "top",
          # strip.background = element_rect(fill = cols2[5]),
          panel.border = element_rect(colour = "grey60",
                                      fill = NA),
          axis.title.y = element_markdown(),
          aspect.ratio = 0.6) +
    xlab("lymphoid proportion*") +
  ylab("mean β<br><b style='color:#C0BE84'>blood sample</b>") +
  new_scale_colour() +
    geom_smooth(method = "lm", se = F,
                aes(x = ic, y = value, colour = smoking_history)) +
    scale_colour_manual(values = cols3[c(13, 1)], name = "")

grDevices::cairo_pdf("2-markdown/1-figure-panels/2a2.pdf", width = 8.5, height = 2.5)
print(a22)
dev.off()

# Cervical
a23 <- data |>
  dplyr::filter(smoking_history != "Ex-smoker" & sampletype == "cervical") |>
    ggplot(aes(x = ic,
               y = value)) +
    geom_point(size = 0.5,
               alpha = 0.3,
               aes(colour = smoking_history)) +
    facet_wrap(~score,ncol = 4, scales = "free_y") +
    scale_colour_manual(values = cols2[c(7, 1)], name = "") +
    theme_bw() +
    theme(legend.position = "top",
          # strip.background = element_rect(fill = cols2[5]),
          panel.border = element_rect(colour = "grey60",
                                      fill = NA),
          axis.title.y = element_markdown(),
          aspect.ratio = 0.6) +
    xlab("immune cell proportion") +
  ylab("mean β<br><b style='color:#C0BE84'>cervical sample</b>") +
  new_scale_colour() +
    geom_smooth(method = "lm", se = F,
                aes(x = ic, y = value, colour = smoking_history)) +
    scale_colour_manual(values = cols3[c(13, 1)], name = "")

grDevices::cairo_pdf("2-markdown/1-figure-panels/2a3.pdf", width = 8.5, height = 2.5)
print(a22)
dev.off()

# B: Venn Diagram ---------------------------
load("1-analysis-pipeline/3-output/venn-sets.Rdata")
p <- ggvenn::ggvenn(sets,
               fill_color = cols[c(9, 6, 4, 2)],
               stroke_size = 0.2, set_name_size = 3.7)

pdf("2-markdown/1-figure-panels/2b.pdf", width = 5, height = 5)
print(p)
dev.off()

# F Pathway enrichment epi_down---------------------------
load("1-analysis-pipeline/3-output/epi_hypo_GO.Rdata")
c <- enrichplot::cnetplot(epi_hypo_bp,
                     size = 3,
                     cex.params = list(category_label = 0.92,
                                       gene_label = 0.9),
                     color.params = list(category = cols[9],
                                         gene = "grey40"),
                     circular = F)
grDevices::pdf("2-markdown/1-figure-panels/2c.pdf", width = 5, height = 5)
print(c)
dev.off()

# G Pathway enrichment imm_hypo---------------------------
load("1-analysis-pipeline/3-output/imm_hypo_GO.Rdata")
d <- enrichplot::cnetplot(imm_hypo_bp,
                     size = 3,
                     cex.params = list(category_label = 0.92,
                                       gene_label = 0.9),
                     color.params = list(category = cols[6],
                                         gene = "grey40"),
                     circular = F)
grDevices::pdf("2-markdown/1-figure-panels/2d.pdf", width = 5, height = 5)
print(d)
dev.off()

# H Pathway enrichment dist_epi_hyper---------------------------
load("1-analysis-pipeline/3-output/dist_epi_hyper_GO.Rdata")
e <- enrichplot::cnetplot(dist_epi_hyper_bp,
                     size = 3,
                     cex.params = list(category_label = 0.92,
                                       gene_label = 0.9),
                     color.params = list(category = cols[3],
                                         gene = "grey40"),
                     circular = F)
grDevices::pdf("2-markdown/1-figure-panels/2e.pdf", width = 5, height = 5)
print(e)
dev.off()

# I Pathway enrichment prox_epi_hyper ---------------------------
load("1-analysis-pipeline/3-output/prox_epi_hyper_GO.Rdata")
f <- enrichplot::cnetplot(prox_epi_hyper_react_all,
                     size = 3,
                     cex.params = list(category_label = 0.92,
                                       gene_label = 0.9),
                     color.params = list(category = cols[1],
                                         gene = "grey40"),

                     circular = F)
grDevices::pdf("2-markdown/1-figure-panels/2f.pdf", width = 5.5, height = 5)
print(f)
dev.off()
```

\textbf{Figure 2. Combined methylation scores of CpGs in the four sets and annotation.}

\newpage

\invisiblesection{Figure 3. Evaluation of scores in an independent validation set.}

```{r fig3}
# load("1-analysis-pipeline/0-data/data.Rdata")
# 
# # Fig 2a-------------------------
# dat <- data |>
#   dplyr::filter(dataset == "validation set" & sampletype == "buccal") |>
#   droplevels() |>
#   dplyr::mutate(smoking_history = factor(smoking_history, levels = c("Never smoker", "Ex-smoker", "Smoker"))) |>
#   correct_ic(correction = "internal")
# 
# dat2 <- dat |>
#   tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM", "WID_SMK450_immune_hypoM", "WID_SMK450_distal_epithelial_hyperM", "WID_SMK450_proximal_epithelial_hyperM"),
#                       names_to = "score",
#                       values_to = "value") |>
#   dplyr::mutate(score = gsub("WID_SMK450_|_corr", "", score),
#                 score = gsub("_", " ", score),
#                 score = factor(score, levels = c("epithelial hypoM",
#                                                  "immune hypoM",
#                                                  "distal epithelial hyperM",
#                                                  "proximal epithelial hyperM")),
#                 smoking_history = factor(smoking_history, levels = c("Never smoker", "Ex-smoker", "Smoker")))
# 
# fig2a <- dat2 |>
#   ggplot(aes(x = ic,
#              y = value)) +
#   # ggdist::stat_halfeye(aes(fill = smoking_history),
#   #                      side = "left",
#   #                      width = 0.8,
#   #                      alpha = 0.7) +
#   # geom_half_boxplot(aes(fill = type),
#   #                   width = 0.2) +
#   geom_point(size = 0.5,
#              aes(colour = smoking_history)) +
#   # gghalves::geom_half_point_panel(aes(colour = smoking_history),
#   #                                 size = 0.5) +
#   facet_wrap(~score,nrow = 1) +
#   scale_colour_manual(values = cols2[c(7, 3, 1)], name = "",
#                       aesthetics = c("fill", "colour")) +
#   theme_minimal() +
#   theme(legend.position = "top",
#         # strip.background = element_rect(fill = cols2[6]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         axis.title.y = element_markdown(),
#         aspect.ratio = 1) +
#   xlab("immune cell proportion") +
#   ylab("mean β<br><span style='color:#224B5E;'><b>buccal samples</b></span></b><br>(raw)") +
#   new_scale_colour() +
#   geom_smooth(aes(x = ic,
#              y = value,
#              colour = smoking_history),
#              method = "lm") +
#   scale_colour_manual(values = cols3[c(13, 4, 1)], name = "",
#                       aesthetics = "colour")
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/2a.pdf", width = 9, height = 4.5)
# print(fig2a)
# dev.off()
# 
# 
# # Fig 2d  (AUC)-------------------------
# dat <- dat |>
#   dplyr::mutate(type = ifelse(smoking_history == "Never smoker", "Control", as.character(smoking_history)),
#                 type = factor(type, levels = c("Control", "Ex-smoker", "Smoker")))
# 
# fig2d <- smallAUCplot(dat, indices = c("WID_SMK450_epithelial_hypoM_corr",
#                                     "WID_SMK450_immune_hypoM_corr",
#                                     "WID_SMK450_distal_epithelial_hyperM_corr",
#                                     "WID_SMK450_proximal_epithelial_hyperM_corr"),
#               types = c("Ex-smoker", "Smoker"),
#                labels = c("epithelial hypoM", "immune hypoM", "distal epithelial hyperM", "proximal epithelial hyperM"),
#               reorder = F,
#               reorder.index = T,
#               reorder.index.levels = c("WID_SMK450_epithelial_hypoM_corr",
#                                        "WID_SMK450_immune_hypoM_corr",
#                                        "WID_SMK450_distal_epithelial_hyperM_corr",
#                                         "WID_SMK450_proximal_epithelial_hyperM_corr"),
#               reverse_base = F,
#               cols = cols2[c(2, 1)],
#               direction = "no_dir",
#               alpha = 0.2,
#               ylim = c(0.2, 1),
#               aspect.ratio = 1.25,
#               print.annotation = T)
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/2d.pdf", width = 4.5, height = 6.25)
# print(fig2d)
# dev.off()
# 
# # Fig 2c (cervical) -------------------------
# dat <- data |>
#   dplyr::filter(dataset == "validation set" & sampletype == "cervical") |>
#   droplevels() |>
#   dplyr::mutate(smoking_history = factor(smoking_history, levels = c("Never smoker", "Ex-smoker", "Smoker"))) |>
#   correct_ic(correction = "internal")
# 
# dat2 <- dat |>
#   tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM", "WID_SMK450_immune_hypoM", "WID_SMK450_distal_epithelial_hyperM", "WID_SMK450_proximal_epithelial_hyperM"),
#                       names_to = "score",
#                       values_to = "value") |>
#   dplyr::mutate(score = gsub("WID_SMK450_", "", score),
#                 score = gsub("_", " ", score),
#                 score = factor(score, levels = c("epithelial hypoM",
#                                                  "immune hypoM",
#                                                  "distal epithelial hyperM",
#                                                  "proximal epithelial hyperM")),
#                 smoking_history = factor(smoking_history, levels = c("Never smoker", "Ex-smoker", "Smoker")))
# 
# fig2c <- dat2 |>
#   ggplot(aes(x = ic,
#              y = value)) +
#   # ggdist::stat_halfeye(aes(fill = smoking_history),
#   #                      side = "left",
#   #                      width = 0.8,
#   #                      alpha = 0.7) +
#   # geom_half_boxplot(aes(fill = type),
#   #                   width = 0.2) +
#   geom_point(size = 0.5,
#              aes(colour = smoking_history)) +
#   # gghalves::geom_half_point_panel(aes(colour = smoking_history),
#   #                                 size = 0.5) +
#   facet_wrap(~score,nrow = 1, scales = "free_y") +
#   scale_colour_manual(values = cols2[c(7, 3, 1)], name = "",
#                       aesthetics = c("fill", "colour")) +
#   theme_minimal() +
#   theme(legend.position = "top",
#         # strip.background = element_rect(fill = cols2[6]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         axis.title.y = element_markdown(),
#         aspect.ratio = 1) +
#   xlab("immune cell proportion") +
#   ylab("mean β<br><span style='color:#C0BE84;'><b>cervical samples</b></span></b><br>(raw)") +
#   new_scale_colour() +
#   geom_smooth(aes(x = ic,
#              y = value,
#              colour = smoking_history),
#              method = "lm") +
#   scale_colour_manual(values = cols3[c(13, 4, 1)], name = "",
#                       aesthetics = "colour")
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/2c.pdf", width = 9, height = 4.5)
# print(fig2c)
# dev.off()
# 
# 
# # Fig 2f  (AUC)-------------------------
# dat <- dat |>
#   dplyr::mutate(type = ifelse(smoking_history == "Never smoker", "Control", as.character(smoking_history)),
#                 type = factor(type, levels = c("Control", "Ex-smoker", "Smoker")))
# 
# fig2e <- smallAUCplot(dat, indices = c("WID_SMK450_epithelial_hypoM_corr",
#                                     "WID_SMK450_immune_hypoM_corr",
#                                     "WID_SMK450_distal_epithelial_hyperM_corr",
#                                     "WID_SMK450_proximal_epithelial_hyperM_corr"),
#               types = c("Ex-smoker", "Smoker"),
#                labels = c("epithelial hypoM", "immune hypoM", "distal epithelial hyperM", "proximal epithelial hyperM"),
#               reorder = F,
#               reorder.index = T,
#               reorder.index.levels = c("WID_SMK450_epithelial_hypoM_corr",
#                                        "WID_SMK450_immune_hypoM_corr",
#                                        "WID_SMK450_distal_epithelial_hyperM_corr",
#                                         "WID_SMK450_proximal_epithelial_hyperM_corr"),
#               reverse_base = F,
#               cols = cols2[c(2, 1)],
#               direction = "no_dir",
#               alpha = 0.2,
#               ylim = c(0.2, 1),
#               aspect.ratio = 1.25,
#               print.annotation = T)
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/2f.pdf", width = 4.5, height = 6.25)
# print(fig2f)
# dev.off()
# 
# # Fig 2b (blood) -------------------------
# dat <- data |>
#   dplyr::filter(dataset == "validation set" & sampletype == "blood") |>
#   droplevels() |>
#   dplyr::mutate(smoking_history = factor(smoking_history, levels = c("Never smoker", "Ex-smoker", "Smoker")))
# 
# dat2 <- dat |>
#   tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM", "WID_SMK450_immune_hypoM", "WID_SMK450_distal_epithelial_hyperM", "WID_SMK450_proximal_epithelial_hyperM"),
#                       names_to = "score",
#                       values_to = "value") |>
#   dplyr::mutate(score = gsub("WID_SMK450_", "", score),
#                 score = gsub("_", " ", score),
#                 ic = 1-(hepidish_Mono+hepidish_Neutro+hepidish_Eosino),
#                 score = factor(score, levels = c("epithelial hypoM",
#                                                  "immune hypoM",
#                                                  "distal epithelial hyperM",
#                                                  "proximal epithelial hyperM")),
#                 smoking_history = factor(smoking_history, levels = c("Never smoker", "Ex-smoker", "Smoker")))
# 
# fig2b <- dat2 |>
#   ggplot(aes(x = ic,
#              y = value)) +
#   # ggdist::stat_halfeye(aes(fill = smoking_history),
#   #                      side = "left",
#   #                      width = 0.8,
#   #                      alpha = 0.7) +
#   # geom_half_boxplot(aes(fill = type),
#   #                   width = 0.2) +
#   geom_point(size = 0.5,
#              aes(colour = smoking_history)) +
#   # gghalves::geom_half_point_panel(aes(colour = smoking_history),
#   #                                 size = 0.5) +
#   facet_wrap(~score,nrow = 1) +
#   scale_colour_manual(values = cols2[c(7, 3, 1)], name = "",
#                       aesthetics = c("fill", "colour")) +
#   theme_minimal() +
#   theme(legend.position = "top",
#         # strip.background = element_rect(fill = cols2[6]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         axis.title.y = element_markdown(),
#         aspect.ratio = 1) +
#   xlab("lymphoid proportion") +
#   ylab("mean β<br><span style='color:#C0BE84;'><b>blood samples</b></span></b><br>(raw)") +
#   new_scale_colour() +
#   geom_smooth(aes(x = ic,
#              y = value,
#              colour = smoking_history),
#              method = "lm") +
#   scale_colour_manual(values = cols3[c(13, 4, 1)], name = "",
#                       aesthetics = "colour")
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/2b.pdf", width = 9, height = 4.5)
# print(fig2b)
# dev.off()
# 
# 
# # Fig 2e  (AUC)-------------------------
# dat <- dat |>
#   dplyr::mutate(type = ifelse(smoking_history == "Never smoker", "Control", as.character(smoking_history)),
#                 type = factor(type, levels = c("Control", "Ex-smoker", "Smoker")))
# 
# fig2f <- smallAUCplot(dat, indices = c("WID_SMK450_epithelial_hypoM",
#                                     "WID_SMK450_immune_hypoM",
#                                     "WID_SMK450_distal_epithelial_hyperM",
#                                     "WID_SMK450_proximal_epithelial_hyperM"),
#               types = c("Ex-smoker", "Smoker"),
#                labels = c("epithelial hypoM", "immune hypoM", "distal epithelial hyperM", "proximal epithelial hyperM"),
#               reorder = F,
#               reorder.index = T,
#               reorder.index.levels = c("WID_SMK450_epithelial_hypoM",
#                                        "WID_SMK450_immune_hypoM",
#                                        "WID_SMK450_distal_epithelial_hyperM",
#                                         "WID_SMK450_proximal_epithelial_hyperM"),
#               reverse_base = F,
#               cols = cols2[c(2, 1)],
#               direction = "no_dir",
#               alpha = 0.2,
#               ylim = c(0.2, 1),
#               aspect.ratio = 1.25,
#               print.annotation = T)
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/2e.pdf", width = 4.5, height = 6.25)
# print(fig2e)
# dev.off()
```

\includegraphics[trim = 0 10cm 0 0]{1-figure-panels/Figure_3.pdf}

\newpage

\invisiblesection{Figure 3. Impact of e-cigarette and moist tobacco use on cell type-specific epigenetic smoking signatures.}

```{r fig3}
# load("1-analysis-pipeline/0-data/data.Rdata")
# 
# # Fig 3a: vaping (overall) -------------------------
# dat <- data |>
#   dplyr::filter(dataset == "vaping set") |>
#   droplevels() |>
#   dplyr::mutate(smoking_history = factor(smoking_history, levels = c("Never smoker", "e-cigarette user", "Smoker"))) |>
#   correct_ic(correction = "internal")
# 
# dat2 <- dat |>
#   tidyr::pivot_longer(cols = c("WID_SMK_epithelial_hypoM_corr", "WID_SMK_immune_hypoM_corr", "WID_SMK_distal_epithelial_hyperM_corr", "WID_SMK_proximal_epithelial_hyperM_corr"),
#                       names_to = "score",
#                       values_to = "value") |>
#   dplyr::mutate(score = gsub("WID_SMK_|_corr", "", score),
#                 score = gsub("_", " ", score),
#                 score = factor(score, levels = c("epithelial hypoM",
#                                                  "immune hypoM",
#                                                  "distal epithelial hyperM",
#                                                  "proximal epithelial hyperM"))) |>
#   dplyr::mutate(smoking_history = factor(smoking_history, levels = c("Never smoker", "e-cigarette user", "Smoker")),
#                 dur = case_when(smoking_history=="e-cigarette user" & vaping_duration == "6 months - 1 year" & !is.na(vaping_duration) ~ "≤1 y",
#                                 smoking_history=="e-cigarette user" & vaping_duration != "6 months - 1 year" & !is.na(vaping_duration) ~ ">1 y",
#                                 smoking_history=="e-cigarette user" & is.na(vaping_duration) ~ "unknown",
#                                 smoking_history=="Smoker" & smk_duration == "6 months - 1 year" & !is.na(smk_duration) ~ "≤1 y",
#                                 smoking_history=="Smoker" & smk_duration == "1 -5 years" & !is.na(smk_duration) ~ ">1 y",
#                                 smoking_history=="Smoker" & smk_duration == "More than 5 years" & !is.na(smk_duration) ~ ">5 y",
#                                 smoking_history=="Smoker" & is.na(smk_duration) ~ "unknown",
#                                 smoking_history=="Never smoker" ~ "Control"),
#                 dur = factor(dur, levels = c("Control",
#                                              "≤1 y",
#                                              ">1 y",
#                                              ">5 y",
#                                              "unknown")))
# 
# fig3a <- dat2 |>
#   ggplot(aes(x = smoking_history,
#              y = value)) +
#   geom_smooth(method = "lm") +
#   # ggdist::stat_eye(aes(fill = smoking_history),
#   #                      width = 0.8,
#   #                  alpha = 0.7) +
#   geom_boxplot(width = 0.5,
#                aes(fill = smoking_history),
#                alpha = 0.5) +
#   ggbeeswarm::geom_beeswarm(aes(colour = smoking_history),
#                             size = 0.3,
#                             alpha = 0.4) +
#   # geom_half_boxplot(aes(fill = type),
#   #                   width = 0.2) +
#   # gghalves::geom_half_point_panel(aes(colour = smoking_history),
#   #                       size = 0.5) +
#   facet_wrap(~score,nrow = 1,
#              scales = "free_y") +
#   scale_colour_manual(values = cols2[c(7, 8, 1)], name = "",
#                       aesthetics = c("fill", "colour")) +
#   theme_minimal() +
#   theme(legend.position = "top",
#         axis.text.x = element_blank(),
#         # strip.background = element_rect(fill = cols2[6]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         axis.title.y = element_markdown(),
#         aspect.ratio = 1) +
#   xlab("") +
#   ylab("mean β<br>(corrected)") +
#   ggtitle("e-cigarette use") +
#   ggpubr::stat_compare_means(comparisons = list(c("Never smoker", "Smoker"),
#                                                 c("Never smoker", "e-cigarette user"),
#                                                 c("e-cigarette user", "Smoker")),
#                              label = "p.format", size = 2.9,
#                              hide.ns = T,
#                              color = "grey40")
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/3a.pdf", width = 9, height = 4.5)
# print(fig3a)
# dev.off()
# 
# # Fig 3b duration (smoking) -------------------------
# b <- dat2 |>
#   dplyr::filter(smoking_history!="e-cigarette user") |> 
#   ggplot(aes(x = dur,
#              y = value)) +
#   # ggdist::stat_eye(aes(fill = smoking_history),
#   #                      width = 0.8,
#   #                  alpha = 0.7) +
#   geom_boxplot(width = 0.5,
#                aes(fill = dur),
#                alpha = 0.5) +
#   ggbeeswarm::geom_beeswarm(aes(colour = dur),
#                             size = 0.3,
#                             alpha = 0.5) +
#   # geom_half_boxplot(aes(fill = type),
#   #                   width = 0.2) +
#   # gghalves::geom_half_point_panel(aes(colour = smoking_history),
#   #                       size = 0.5) +
#   facet_wrap(~score, nrow = 1,scales = "free_y") +
#   scale_colour_manual(values = cols2[c(7, 3, 2, 1, 6)], name = "",
#                       aesthetics = c("fill", "colour")) +
#   theme_minimal() +
#   theme(
#     legend.position = "top",
#         axis.text.x = element_blank(),
#         # strip.background = element_rect(fill = cols2[6]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         aspect.ratio = 1) +
#   xlab("") +
#   ylab("mean β\n(corrected)") +
#   labs(subtitle = "cigarette smoking") +
#   ggpubr::stat_compare_means(ref.group = "Control",
#                              label = "p.signif", size = 2.7,
#                              hide.ns = T,
#                              colour = "grey20",
#                              label.y.npc = 0.9)
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/3b.pdf", width = 9, height = 4.5)
# print(b)
# dev.off()
# 
# c <- dat2 |>
#   dplyr::filter(smoking_history!="Smoker") |>
#   ggplot(aes(x = dur,
#              y = value)) +
#   # ggdist::stat_eye(aes(fill = smoking_history),
#   #                      width = 0.8,
#   #                  alpha = 0.7) +
#   geom_boxplot(width = 0.5,
#                aes(fill = dur),
#                alpha = 0.5) +
#   ggbeeswarm::geom_beeswarm(aes(colour = dur),
#                             size = 0.3,
#                             alpha = 0.5) +
#   # geom_half_boxplot(aes(fill = type),
#   #                   width = 0.2) +
#   # gghalves::geom_half_point_panel(aes(colour = smoking_history),
#   #                       size = 0.5) +
#   facet_wrap(~score, nrow = 1, scales = "free_y") +
#   scale_colour_manual(values = cols2[c(7, 3, 2, 6)], name = "",
#                       aesthetics = c("fill", "colour")) +
#   theme_minimal() +
#   theme(legend.position = "top",
#         axis.text.x = element_blank(),
#         # strip.background = element_rect(fill = cols2[6]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         aspect.ratio = 1) +
#   xlab("") +
#   ylab("mean β\n(corrected)") +
#   labs(subtitle = "e-cigarette use") +
#   ggpubr::stat_compare_means(ref.group = "Control",
#                              label = "p.signif", size = 2.7,
#                              hide.ns = T,
#                              label.y.npc = 0.9,
#                              colour = "grey20")
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/3c.pdf", width = 9, height = 4.5)
# print(c)
# dev.off()
# 
# 
# # Fig 3d: auc -------------------------
# dat <- dat |>
#   dplyr::mutate(type = ifelse(smoking_history == "Never smoker", "Control", as.character(smoking_history)),
#                 type = factor(type, levels = c("Control", "e-cigarette user", "Smoker")))
# 
# fig3d <- smallAUCplot(dat, indices = c("WID_SMK_epithelial_hypoM_corr",
#                                     "WID_SMK_immune_hypoM_corr",
#                                     "WID_SMK_distal_epithelial_hyperM_corr",
#                                     "WID_SMK_proximal_epithelial_hyperM_corr"),
#               types = c("e-cigarette user", "Smoker"),
#                labels = c("epithelial hypoM", "immune hypoM", "distal epithelial hyperM", "proximal epithelial hyperM"),
#               reorder = F,
#               reorder.index = T,
#               reorder.index.levels = c("WID_SMK_epithelial_hypoM_corr",
#                                        "WID_SMK_immune_hypoM_corr",
#                                        "WID_SMK_distal_epithelial_hyperM_corr",
#                                         "WID_SMK_proximal_epithelial_hyperM_corr"),
#               reverse_base = F,
#               cols = cols2[c(8, 1)],
#               direction = "no_dir",
#               alpha = 0.2,
#               ylim = c(0.2, 1),
#               aspect.ratio = 1.25,
#               print.annotation = T)
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/3d.pdf", width = 4.5, height = 6.25)
# print(fig3d)
# dev.off()
# 
# # Fig 3e: Snus -------------------------
# load("1-analysis-pipeline/4-datasets/1-output/snuff_tobacco.Rdata")
# dat <- pheno |>
#   dplyr::mutate(smoking_current = case_when(smoking_current == "Control" ~ "Non-smoker",
#                                             smoking_current == "Cigarette Smoker" ~ "Smoker",
#                                             smoking_current == "Moist Snuff User" ~ "Smokeless tobacco user"),
#                 smoking_history = smoking_current) |>
#   correct_ic(correction = "internal")
# 
# dat2 <- dat |>
#   tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM_corr", "WID_SMK450_immune_hypoM_corr", "WID_SMK450_distal_epithelial_hyperM_corr", "WID_SMK450_proximal_epithelial_hyperM_corr"),
#                       names_to = "score",
#                       values_to = "value") |>
#   dplyr::mutate(score = gsub("WID_SMK450_|_corr", "", score),
#                 score = gsub("_", " ", score),
#                 score = factor(score, levels = c("epithelial hypoM",
#                                                  "immune hypoM",
#                                                  "distal epithelial hyperM",
#                                                  "proximal epithelial hyperM")),
#                 smoking_history = factor(smoking_history, levels = c("Non-smoker", "Smokeless tobacco user", "Smoker")))
# 
# fig3e <- dat2 |>
#   ggplot(aes(x = smoking_history,
#              y = value)) +
#   geom_boxplot(width = 0.5,
#                aes(fill = smoking_history),
#                alpha = 0.5) +
#   ggbeeswarm::geom_beeswarm(aes(colour = smoking_history),
#                             size = 0.3,
#                             alpha = 0.4) +
#   facet_wrap(~score,nrow = 1) +
#   scale_colour_manual(values = cols2[c(7,4,1)], name = "",
#                       aesthetics = c("fill", "color")) +
#   theme_minimal() +
#   theme(legend.position = "top",
#         axis.text.x = element_blank(),
#         # strip.background = element_rect(fill = cols2[5]),
#         panel.border = element_rect(colour = "grey60",
#                                     fill = NA),
#         aspect.ratio = 1) +
#   xlab("") +
#   ylab("mean β\n") +
#   ggtitle("Smokeless tobacco user") +
#   ggpubr::stat_compare_means(comparisons = list(c("Non-smoker", "Smoker"),
#                                                 c("Non-smoker", "Smokeless tobacco user"),
#                                                 c("Smokeless tobacco user", "Smoker")),
#                              label = "p.format", size = 2.9,
#                              hide.ns = T,
#                              color = "grey40")
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/3e.pdf", width = 9, height = 4.5)
# print(fig3e)
# dev.off()
# 
# # Fig 3f -------------------------
# dat <- dat |>
#   dplyr::mutate(type = ifelse(smoking_current == "Non-smoker", "Control", as.character(smoking_current)),
#                 type = factor(type, levels = c("Control", "Smokeless tobacco user", "Smoker")))
# 
# fig3f <- smallAUCplot(dat, indices = c("WID_SMK450_epithelial_hypoM_corr",
#                                     "WID_SMK450_immune_hypoM_corr",
#                                     "WID_SMK450_distal_epithelial_hyperM_corr",
#                                     "WID_SMK450_proximal_epithelial_hyperM_corr"),
#               types = c("Smokeless tobacco user", "Smoker"),
#                labels = c("epithelial hypoM", "immune hypoM", "distal epithelial hyperM", "proximal epithelial hyperM"),
#               reorder = F,
#               reorder.index = T,
#               reorder.index.levels = c("WID_SMK450_epithelial_hypoM_corr",
#                                        "WID_SMK450_immune_hypoM_corr",
#                                        "WID_SMK450_distal_epithelial_hyperM_corr",
#                                         "WID_SMK450_proximal_epithelial_hyperM_corr"),
#               reverse_base = F,
#               cols = cols2[c(3, 1)],
#               direction = "no_dir",
#               alpha = 0.2,
#               ylim = c(0.2, 1),
#               aspect.ratio = 1.25,
#               print.annotation = T)
# 
# grDevices::cairo_pdf("2-markdown/1-figure-panels/3f.pdf", width = 4.5, height = 6.25)
# print(fig3f)
# dev.off()
```

\includegraphics[trim = 0 11cm 0 0]{1-figure-panels/Figure_3.pdf}

\newpage

\invisiblesection{Figure 4. Scores in cancer samples and progressing versus regrressing carcinoma in situ lesions.}

```{r fig4}
load("1-analysis-pipeline/4-datasets/1-output/tcga.Rdata")

# Fig a - ic -----------------
# isolate matched samples (same exposure only)
matched <- tcga_data |>
  dplyr::group_by(barcode3) |>
  dplyr::summarise(x = paste0(type, collapse = ",")) |>
  dplyr::filter(x %in% c("Control,Cancer", "Cancer,Control"))

tmp <- tcga_data |>
  dplyr::filter(barcode3 %in% matched$barcode3) |>
  tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM", "WID_SMK450_immune_hypoM", "WID_SMK450_distal_epithelial_hyperM", "WID_SMK450_proximal_epithelial_hyperM"),
                      names_to = "score",
                      values_to = "value") |>
  dplyr::mutate(score = gsub("WID_SMK450_|", "", score),
                score = gsub("_", " ", score),
                score = factor(score, levels = c("epithelial hypoM",
                                                 "immune hypoM",
                                                 "distal epithelial hyperM",
                                                 "proximal epithelial hyperM")),
                type = case_when(type == "Cancer" ~ "Cancer tissue",
                                 type == "Control" ~ "Matched normal tissue"),
                type = factor(type, levels = c("Matched normal tissue",
                                               "Cancer tissue")))


a <- tmp |>
  arrange(project, score, barcode3, type) |>
  ggplot(aes(x = type,
             y = value)) +
  geom_boxplot(aes(fill = type),
               alpha = 0.4) +
  geom_line(aes(group = barcode3),
            linewidth = 0.3,
            alpha = 0.5,
            colour = "gray50") +
  geom_point(aes(colour = type),
                            size = 0.7,
                            alpha = 0.9) +
  facet_wrap(project~score, nrow = 2, scales = "free_y") +
  scale_colour_manual(values = cols2[c(9,1)], name = "",
                      aesthetics = c("color", "fill")) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_blank(),
        # strip.background = element_rect(fill = cols2[5]),
        panel.border = element_rect(colour = "grey60",
                                    fill = NA),
        aspect.ratio = 1.3) +
  xlab("") +
  ylab("mean β\n") +
  ggpubr::stat_compare_means(
                             comparisons = list(c("Matched normal tissue", "Cancer tissue")),
                             label = 'p.format',
                             label.y.npc = 0.9,
                             paired = T) +
  coord_cartesian(clip = "off")

grDevices::cairo_pdf("2-markdown/1-figure-panels/4a.pdf", width = 9, height = 9)
print(a)
dev.off()

# # Fig 5b AUCplot LUAD and LUSC (matched samples only) --------------------------
# library(pROC)
# indices <- c("WID_SMK450_epithelial_hypoM",
#              "WID_SMK450_immune_hypoM",
#              "WID_SMK450_distal_epithelial_hyperM",
#              "WID_SMK450_proximal_epithelial_hyperM")
# print.annotation = T
# typevar <- "type"
#
# # ROC For manuscript
# tmp <- tcga_data |>
#   dplyr::filter(barcode3 %in% matched$barcode3) |>
#   dplyr::mutate(type = case_when(type == "Cancer" ~ "Cancer tissue",
#                                  type == "Control" ~ "Matched normal tissue"),
#                 type = factor(type, levels = c("Matched normal tissue",
#                                                "Cancer tissue")))
#
#
#
# roc <- roc(tmp$type, tmp$WID_SMK450_proximal_epithelial_hyperM)
# ci <- ci(roc)
#
# # LUAD -----------------------
# tmp <- tcga_data |>
#   dplyr::filter(barcode3 %in% matched$barcode3) |>
#   dplyr::filter(project == "TCGA-LUAD") |>
#   dplyr::mutate(type = factor(type, levels = c("Control", "Cancer")))
# types <- "Cancer"
# df <- data.frame(matrix(nrow = length(indices)*length(types),
#                         ncol = 7))
# colnames(df) <- c("index", "AUC", "lo", "hi", "type", "annotation", "sig")
# df$index <- indices
#
# df$type <- rep(types, each = length(indices))
# df$type <- factor(df$type, levels = types)
#
# for (i in 1:length(indices)){
#
#   if(indices[i] %in% c("WID_SMK450_epithelial_hypoM",
#                          "WID_SMK450_immune_hypoM")){
#       roc <- pROC::roc(tmp[[typevar]], tmp[[indices[i]]], direction = ">")
#     } else {
#       roc <- pROC::roc(tmp[[typevar]], tmp[[indices[i]]], direction = "<")
#     }
#     ci <- ci(roc)
#
#     df[df$index==indices[i] & df$type==types,]$AUC <- as.numeric(ci)[2]
#     df[df$index==indices[i] & df$type==types,]$lo <- as.numeric(ci)[1]
#     df[df$index==indices[i] & df$type==types,]$hi <- as.numeric(ci)[3]
#
#     if(print.annotation!=F){
#       df[df$index==indices[i] & df$type==types,]$annotation <- as.character(paste0("AUC=",
#                                                                                       signif(as.numeric(ci)[2], 2),
#                                                                                       "\n(", signif(as.numeric(ci)[1],2),
#                                                                                       "-",
#                                                                                       signif(as.numeric(ci)[3], 2),
#                                                                                       ")"))
#
#       df[df$index==indices[i] & df$type==types,]$sig <- case_when((as.numeric(ci)[2] > 0.5 & as.numeric(ci)[1] > 0.5) | (as.numeric(ci)[2] < 0.5 & as.numeric(ci)[3] < 0.5) ~ "yes",
#                                                                      TRUE ~ "no")
#       df[df$index==indices[i] & df$type==types,]$annotation <- ifelse(df[df$index==indices[i] & df$type==types,]$sig  == "yes", paste0(df[df$index==indices[i] & df$type==types,]$annotation, "*"), paste0(df[df$index==indices[i] & df$type==types,]$annotation))
#     } else {
#       df[df$index==indices[i] & df$type==types,]$annotation <- ""
#     }
#   }
#
# df_luad <- df
# df_luad$type <- "LUAD"
#
# # LUSC
# tmp <- tcga_data |>
#   dplyr::filter(barcode3 %in% matched$barcode3) |>
#   dplyr::filter(project == "TCGA-LUSC") |>
#   dplyr::mutate(type = factor(type, levels = c("Control", "Cancer")))
# types <- "Cancer"
# df <- data.frame(matrix(nrow = length(indices)*length(types),
#                         ncol = 7))
# colnames(df) <- c("index", "AUC", "lo", "hi", "type", "annotation", "sig")
# df$index <- indices
#
# df$type <- rep(types, each = length(indices))
# df$type <- factor(df$type, levels = types)
#
# for (i in 1:length(indices)){
#
#   if(indices[i] %in% c("WID_SMK450_epithelial_hypoM",
#                        "WID_SMK450_immune_hypoM")){
#     roc <- pROC::roc(tmp[[typevar]], tmp[[indices[i]]], direction = ">")
#   } else {
#     roc <- pROC::roc(tmp[[typevar]], tmp[[indices[i]]], direction = "<")
#   }
#   ci <- ci(roc)
#
#   df[df$index==indices[i] & df$type==types,]$AUC <- as.numeric(ci)[2]
#   df[df$index==indices[i] & df$type==types,]$lo <- as.numeric(ci)[1]
#   df[df$index==indices[i] & df$type==types,]$hi <- as.numeric(ci)[3]
#
#   if(print.annotation!=F){
#     df[df$index==indices[i] & df$type==types,]$annotation <- as.character(paste0("AUC=",
#                                                                                     signif(as.numeric(ci)[2], 2),
#                                                                                     "\n(", signif(as.numeric(ci)[1],2),
#                                                                                     "-",
#                                                                                     signif(as.numeric(ci)[3], 2),
#                                                                                     ")"))
#
#     df[df$index==indices[i] & df$type==types,]$sig <- case_when((as.numeric(ci)[2] > 0.5 & as.numeric(ci)[1] > 0.5) | (as.numeric(ci)[2] < 0.5 & as.numeric(ci)[3] < 0.5) ~ "yes",
#                                                                    TRUE ~ "no")
#     df[df$index==indices[i] & df$type==types,]$annotation <- ifelse(df[df$index==indices[i] & df$type==types,]$sig  == "yes", paste0(df[df$index==indices[i] & df$type==types,]$annotation, "*"), paste0(df[df$index==indices[i] & df$type==types,]$annotation))
#   } else {
#     df[df$index==indices[i] & df$type==types,]$annotation <- ""
#   }
# }
#
# df_lusc <- df
# df_lusc$type <- "LUSC"
#
# df <- rbind(df_luad, df_lusc)
#
# types <- c("LUAD", "LUSC")
# cols <- cols2[c(2,1)]
#
# alpha = 0.2
# aspect.ratio = 1.25
#
# # Reorder factors
# df <- df |>
#   dplyr::mutate(score = gsub("WID_SMK450_", "", index),
#                 score = gsub("_", " ", score),
#                 score = factor(score, levels = c("epithelial hypoM",
#                                  "immune hypoM",
#                                  "distal epithelial hyperM",
#                                  "proximal epithelial hyperM")))
#
# fig4b <- df |>
#   ggplot(aes(x = score,
#              y = AUC,
#              group = type)) +
#   geom_point(size = 3,
#              aes(colour = type)) +
#   geom_errorbar(aes(ymin = lo,
#                     ymax = hi,
#                     colour = type),
#                 width = 0) +
#   geom_ribbon(aes(ymin = lo,
#                   ymax = hi,
#                   fill = type),
#               alpha = alpha) +
#   geom_text(aes(y = 0.38,
#                 label = annotation,
#                 colour = type,
#                 fontface = ifelse(sig == "yes", 2, 1)),
#             size = 3,
#             nudge_y = case_when(df$type == types[1] & length(types) == 2 ~ -0.05,
#                                 df$type == types[2] & length(types) == 2 ~ +0.05,
#                                 df$type == types[1] & length(types) == 4 ~ 0.2,
#                                 df$type == types[2] & length(types) == 4 ~ 0.08,
#                                 df$type == types[3] & length(types) == 4 ~ -0.08,
#                                 df$type == types[4] & length(types) == 4 ~ -0.2),
#             show.legend = F) +
#   geom_hline(yintercept = 0.5,
#              linetype = "dotted") +
#   theme_bw() +
#   # ylim(ylim) +
#   scale_colour_manual(name = "",
#                       values = cols,
#                       aesthetics = c("colour", "fill")) +
#   theme(legend.position = "top",
#         aspect.ratio = aspect.ratio,
#         axis.text.x = element_text(angle = 60,
#                                    hjust = 1)) +
#   xlab("")

# AUC LUAD
luad <- tcga_data |>
  dplyr::filter(barcode3 %in% matched$barcode3) |>
  dplyr::filter(project == "TCGA-LUAD") |>
  dplyr::mutate(type = factor(type, levels = c("Control", "Cancer")))

b <- plot_3_rocs(luad$type, # Type; Case and control, ideally ordered as a factor (base = control)
                    index1 = luad$WID_SMK450_epithelial_hypoM, title1 = "epithelial hypoM", col1 = cols[9],
                    index2 = luad$WID_SMK450_distal_epithelial_hyperM, title2 = "distal epithelial hyperM", col2 = cols[3],
                    index3 = luad$WID_SMK450_proximal_epithelial_hyperM, title3 = "proximal epithelial hyperM",col3 = cols[1])
b <- b + plot_annotation(title = "TCGA-LUAD")
grDevices::cairo_pdf("2-markdown/1-figure-panels/4b.pdf", width = 4.5, height = 4.5)
print(b)
dev.off()

lusc <- tcga_data |>
  dplyr::filter(barcode3 %in% matched$barcode3) |>
  dplyr::filter(project == "TCGA-LUSC") |>
  dplyr::mutate(type = factor(type, levels = c("Control", "Cancer")))

c <- plot_3_rocs(lusc$type, # Type; Case and control, ideally ordered as a factor (base = control)
                    index1 = lusc$WID_SMK450_epithelial_hypoM, title1 = "epithelial hypoM", col1 = cols[9],
                    index2 = lusc$WID_SMK450_distal_epithelial_hyperM, title2 = "distal epithelial hyperM", col2 = cols[3],
                    index3 = lusc$WID_SMK450_proximal_epithelial_hyperM, title3 = "proximal epithelial hyperM",col3 = cols[1])
c <- c + plot_annotation(title = "TCGA-LUSC")
grDevices::cairo_pdf("2-markdown/1-figure-panels/4c.pdf", width = 4.5, height = 4.5)
print(c)
dev.off()

# Fig 4C CIS progression --------------------------
load("1-analysis-pipeline/4-datasets/1-output/cis_progression.Rdata")

tmp <- pheno |>
  tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM", "WID_SMK450_immune_hypoM", "WID_SMK450_distal_epithelial_hyperM", "WID_SMK450_proximal_epithelial_hyperM"),
                      names_to = "score",
                      values_to = "value") |>
  dplyr::mutate(score = gsub("WID_SMK450_|", "", score),
                score = gsub("_", " ", score),
                score = factor(score, levels = c("epithelial hypoM",
                                                 "immune hypoM",
                                                 "distal epithelial hyperM",
                                                 "proximal epithelial hyperM")),
                type = case_when(type == "Control" ~ "Control tissue",
                                 type == "Regression" ~ "Regressing CIS lesion",
                                 type == "Progression" ~ "Progressing CIS lesion"),
                type = factor(type, levels = c("Control tissue",
                                               "Regressing CIS lesion",
                                               "Progressing CIS lesion")))

d <- tmp |>
  ggplot(aes(x = type,
             y = value)) +
  geom_boxplot(aes(fill = type),
               alpha = 0.4) +
  ggbeeswarm::geom_beeswarm(aes(colour = type),
                            size = 0.7) +
  facet_wrap(~score, nrow = 1, scales = "free") +
  xlab("") +
  ylab("mean β\n")+
  scale_colour_manual(values = cols2[c(9,7,1)], name = "",
                      aesthetics = c("color", "fill")) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_blank(),
        # strip.background = element_rect(fill = cols2[5]),
        panel.border = element_rect(colour = "grey60",
                                    fill = NA),
        aspect.ratio = 1.3) +
  ggpubr::stat_compare_means(comparisons = list(c("Control tissue", "Progressing CIS lesion"),
                                                c("Control tissue", "Regressing CIS lesion"),
                                                c("Progressing CIS lesion", "Regressing CIS lesion")),
                             label = "p.label")
grDevices::cairo_pdf("2-markdown/1-figure-panels/4d.pdf", width = 9, height = 5)
print(d)
dev.off()

prog_v_reg <- pheno |>
  dplyr::filter(type %in% c("Regression", "Progression")) |>
  droplevels()

e <- plot_3_rocs(prog_v_reg$type, # Type; Case and control, ideally ordered as a factor (base = control)
                    index1 = prog_v_reg$WID_SMK450_epithelial_hypoM, title1 = "epithelial hypoM", col1 = cols[9],
                    index2 = prog_v_reg$WID_SMK450_distal_epithelial_hyperM, title2 = "distal epithelial hyperM", col2 = cols[3],
                    index3 = prog_v_reg$WID_SMK450_proximal_epithelial_hyperM, title3 = "proximal epithelial hyperM",col3 = cols[1])
e <- e + plot_annotation(title = "Regressing versus progressing CIS lesion")

# Cervical
load("1-analysis-pipeline/4-datasets/1-output/cervical-cancer.Rdata")

matched = pheno |>
  dplyr::group_by(id) |>
  dplyr::count(type) |>
  tidyr::pivot_wider(id_cols = id,
                     names_from = type,
                     values_from = n) |>
  dplyr::filter(Cancer == 1 & Control==1)


tmp <- pheno |>
  dplyr::filter(id %in% matched$id) |>
  tidyr::pivot_longer(cols = c("WID_SMK450_epithelial_hypoM", "WID_SMK450_immune_hypoM", "WID_SMK450_distal_epithelial_hyperM", "WID_SMK450_proximal_epithelial_hyperM"),
                      names_to = "score",
                      values_to = "value") |>
  dplyr::mutate(score = gsub("WID_SMK450_|", "", score),
                score = gsub("_", " ", score),
                score = factor(score, levels = c("epithelial hypoM",
                                                 "immune hypoM",
                                                 "distal epithelial hyperM",
                                                 "proximal epithelial hyperM")),
                type = case_when(type == "Cancer" ~ "Cancer tissue",
                                 type == "Control" ~ "Matched normal tissue"),
                type = factor(type, levels = c("Matched normal tissue",
                                               "Cancer tissue")))

f <- tmp |>
  arrange(score, id, type) |>
  ggplot(aes(x = type,
             y = value)) +
  geom_boxplot(aes(fill = type),
               alpha = 0.4) +
  geom_line(aes(group = id),
            linewidth = 0.3,
            alpha = 0.5,
            colour = "gray50") +
  geom_point(aes(colour = type),
                            size = 0.7,
                            alpha = 0.9) +
  facet_wrap(~score, nrow = 1, scales = "free_y") +
  scale_colour_manual(values = cols2[c(9,1)], name = "",
                      aesthetics = c("color", "fill")) +
  theme_minimal() +
  theme(legend.position = "top",
        axis.text.x = element_blank(),
        axis.title.y = element_markdown(),
        # strip.background = element_rect(fill = cols2[5]),
        panel.border = element_rect(colour = "grey60",
                                    fill = NA),
        aspect.ratio = 1.3) +
  xlab("") +
  ylab("mean β<br>cervical tissue") +
  ggpubr::stat_compare_means(
                             comparisons = list(c("Matched normal tissue", "Cancer tissue")),
                             label = 'p.format',
                             label.y.npc = 0.9,
                             paired = T) +
  coord_cartesian(clip = "off")

grDevices::cairo_pdf("2-markdown/1-figure-panels/4f.pdf", width = 9, height = 5)
print(f)
dev.off()

tmp <- pheno |>
  dplyr::filter(id %in% matched$id) |>
  dplyr::mutate(type = factor(type, levels = c("Control", "Cancer")))

g <- plot_2_rocs(tmp$type, # Type; Case and control, ideally ordered as a factor (base = control)
                    index1 = tmp$WID_SMK450_distal_epithelial_hyperM, title1 = "distal epithelial hyperM", col1 = cols[3],
                    index2 = tmp$WID_SMK450_proximal_epithelial_hyperM, title2 = "proximal epithelial hyperM", col2 = cols[1])
g <- g + plot_annotation(title = "Cervical tissue")

grDevices::cairo_pdf("2-markdown/1-figure-panels/4g.pdf", width = 4.5, height = 4.5)
print(g)
dev.off()
```

\includegraphics[trim = 0 10cm 0 0]{1-figure-panels/Figure_4.pdf}


\invisiblesection{Figure 5. Prediction of lung cancer}

```{r fig5}
# A - provided by Raut Janhavi

# B  blood -----
load("~/Dropbox/index-dev/SMK-index/16-manuscript/WID_SMK_code/1-analysis-pipeline/0-data/nshd_internal.Rdata")
pheno <- pheno |>
  dplyr::mutate(type = type2)

# Matched
m <- pheno |>
  dplyr::group_by(id_anon) |>
  dplyr::mutate(count = n()) |>
  dplyr::filter(count == 2) |>
  ungroup()

dat <- pheno |>
  dplyr::filter(sampletype == "blood" & id_anon %in% m$id_anon & smoking_history == "Smoker")

b <- plot_3_rocs(dat$type, # Type; Case and control, ideally ordered as a factor (base = control)
                        index1 = dat$cg05575921, title1 = "AHRR", # AHRR methylation
                        index2 = dat$cg03636183, title2 = "F2RL3", # F2RL3 methylation
                        index3 = dat$WID_SMK450_immune_hypoM, title3 = "immune hypoM") # Immune HypoM signature

b <- b+ plot_annotation(title = "Matched samples (blood)\nlung or airway cancer incidence")
grDevices::cairo_pdf("2-markdown/1-figure-panels/5b.pdf", width = 4.5, height = 4.5)
print(b)
dev.off()

dat <- pheno |>
  dplyr::filter(sampletype == "buccal" & id_anon %in% m$id_anon & smoking_history == "Smoker") |>
  correct_ic(scores = c("cg05575921",
                        "WID_SMK450_proximal_epithelial_hyperM"))

c <- plot_3_rocs(dat$type, # Type; Case and control, ideally ordered as a factor (base = control)
                        index1 = dat$cg05575921_corr, title1 = "AHRR", # AHRR methylation
                        index2 = dat$cg03636183, title2 = "F2RL3", # F2RL3 methylation
                        index3 = dat$WID_SMK450_proximal_epithelial_hyperM_corr, title3 = "proximal epithelial hyperM", col3 = cols[2]) # Immune HypoM signature
c <- c+ plot_annotation(title = "Matched samples (buccal)\nlung or airway cancer incidence")
grDevices::cairo_pdf("2-markdown/1-figure-panels/5c.pdf", width = 4.5, height = 4.5)
print(c)
dev.off()
```

\includegraphics[trim = 0 10cm 0 0]{1-figure-panels/Figure_5.pdf}
